{% extends "base.html" %}

{% block title %}AI æ™ºèƒ½å¯¼è´­ - B2Cå•†åŸ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary bg-gradient text-white d-flex justify-content-between align-items-center py-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-robot fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0 fw-bold">AI æ™ºèƒ½å¯¼è´­åŠ©æ‰‹</h5>
                        <small class="opacity-75" style="font-size: 0.8rem;">Powered by Qwen-Turbo | Read-Only Mode</small>
                    </div>
                </div>
                <span class="badge bg-light text-primary fw-bold">
                    <i class="bi bi-shield-lock"></i> å®‰å…¨ä¿æŠ¤ä¸­
                </span>
            </div>

            <div class="card-body bg-light">
                <div id="chat-history" class="pe-2 mb-3" style="height: 500px; overflow-y: auto;">

                    <div class="mb-4">
                        <div class="d-flex align-items-start">
                            <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center flex-shrink-0 mt-1" style="width: 35px; height: 35px;">AI</div>
                            <div class="ms-2">
                                <div class="bg-white p-3 rounded shadow-sm border" style="max-width: 85%;">
                                    <p class="mb-2">ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯å•†åŸçš„æ•°æ®åº“æ™ºèƒ½åŠ©æ‰‹ã€‚</p>
                                    <p class="mb-0 text-muted small">æ‚¨å¯ä»¥è¿™æ ·é—®æˆ‘ï¼š</p>
                                    <ul class="mb-0 ps-3 small text-muted">
                                        <li>â€œæŸ¥ä¸€ä¸‹ iPhone 15 çš„ä»·æ ¼å’Œåº“å­˜â€</li>
                                        <li>â€œå°ç±³æ‰‹æœºè¿˜æœ‰è´§å—ï¼Ÿâ€</li>
                                        <li>â€œæœ€ä¾¿å®œçš„å•†å“æ˜¯å“ªä¸ªï¼Ÿâ€</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="input-group input-group-lg shadow-sm">
                    <input type="text" id="user-input" class="form-control border-0" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜... (ä¾‹å¦‚: æŸ¥ä¸€ä¸‹iPhoneåº“å­˜)" onkeydown="if(event.keyCode==13) sendMsg()">
                    <button class="btn btn-primary px-4" type="button" onclick="sendMsg()">
                        <i class="bi bi-send-fill"></i> å‘é€
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function sendMsg() {
        var inputVal = $('#user-input').val().trim();
        if(!inputVal) return;

        // 1. æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯ (å³ä¾§)
        $('#chat-history').append(`
            <div class="mb-4 text-end">
                <div class="d-inline-block text-start">
                    <div class="bg-primary text-white p-3 rounded shadow-sm" style="max-width: 100%; border-radius: 15px 15px 0 15px !important;">
                        ${inputVal}
                    </div>
                </div>
                <div class="bg-dark text-white rounded-circle d-inline-flex justify-content-center align-items-center ms-2 align-top mt-1" style="width: 35px; height: 35px;">
                    <i class="bi bi-person-fill"></i>
                </div>
            </div>
        `);

        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
        $('#user-input').val('');
        scrollToBottom();

        // 2. æ˜¾ç¤º"æ€è€ƒä¸­"åŠ è½½çŠ¶æ€
        var loadingId = 'loading-' + Date.now();
        $('#chat-history').append(`
            <div id="${loadingId}" class="mb-4 d-flex align-items-center text-muted small ms-5">
                <div class="spinner-border spinner-border-sm me-2 text-primary" role="status"></div>
                AI æ­£åœ¨ç”Ÿæˆ SQL å¹¶æŸ¥è¯¢åªè¯»æ•°æ®åº“...
            </div>
        `);
        scrollToBottom();

        // 3. å‘é€ AJAX è¯·æ±‚ç»™åç«¯
        $.post('/ai/query', {query: inputVal}, function(res){
            // ç§»é™¤åŠ è½½åŠ¨ç”»
            $(`#${loadingId}`).remove();

            if(res.code === 200) {
                // ===========================================
                // ğŸ¨ æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆå•†å“å¡ç‰‡ HTML
                // ===========================================
                let contentHtml = '';

                if(res.data && res.data.length > 0) {
                    contentHtml += '<div class="row g-2 mt-2">'; // ä½¿ç”¨ Grid å¸ƒå±€

                    res.data.forEach(item => {
                        // å®¹é”™å¤„ç†ï¼šé€‚é…ä¸åŒçš„å­—æ®µå
                        let name = item.name || item.product_name || 'æœªçŸ¥å•†å“';
                        let price = item.price || 0;
                        let stock = item.stock;
                        // å¦‚æœåº“å­˜æ˜¯ None/Undefinedï¼Œæ˜¾ç¤º 'æœªçŸ¥'
                        if (stock === undefined || stock === null) stock = '?';

                        let sku = item.sp_data || item.sku_code || item.product_sn || 'æ ‡å‡†è§„æ ¼';

                        // æ„å»ºå•ä¸ªå¡ç‰‡
                        contentHtml += `
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm bg-light">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-start mb-2">
                                            <div class="bg-white p-1 rounded border me-2 text-primary">
                                                <i class="bi bi-box-seam fs-4"></i>
                                            </div>
                                            <div>
                                                <h6 class="card-title fw-bold mb-0 text-truncate" style="max-width: 150px;" title="${name}">${name}</h6>
                                                <small class="text-muted" style="font-size:0.75rem">${sku}</small>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-1">
                                            <span class="text-danger fw-bold">Â¥${price}</span>
                                            <span class="badge ${stock > 0 ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'} border">
                                                åº“å­˜: ${stock}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    contentHtml += '</div>'; // End Row
                } else {
                    contentHtml = '<div class="alert alert-secondary py-2 small mt-2"><i class="bi bi-search"></i> æ•°æ®åº“ä¸­æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“æ•°æ®ã€‚</div>';
                }

                // ===========================================
                // æ¸²æŸ“ AI å›å¤æ¶ˆæ¯ (å·¦ä¾§)
                // ===========================================
                $('#chat-history').append(`
                    <div class="mb-4">
                        <div class="d-flex align-items-start">
                            <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center flex-shrink-0 mt-1" style="width: 35px; height: 35px;">AI</div>
                            <div class="ms-2" style="max-width: 85%;">
                                <div class="bg-white p-3 rounded shadow-sm border">
                                    <p class="mb-1 text-dark">${res.answer}</p>

                                    ${contentHtml}

                                    <div class="accordion accordion-flush mt-3 border rounded" id="accordion-${Date.now()}">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed py-2 px-3 bg-light small" type="button" data-bs-toggle="collapse" data-bs-target="#flush-${Date.now()}">
                                                    <i class="bi bi-code-square me-2 text-muted"></i>
                                                    <span class="text-muted small">æŸ¥çœ‹ç”Ÿæˆçš„ SQL (ç­”è¾©æ¼”ç¤º)</span>
                                                </button>
                                            </h2>
                                            <div id="flush-${Date.now()}" class="accordion-collapse collapse">
                                                <div class="accordion-body bg-dark p-2">
                                                    <code class="text-warning small" style="word-break: break-all;">${res.sql}</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                `);

            } else {
                // å¤„ç†é”™è¯¯ (çº¢è‰²æ°”æ³¡)
                $('#chat-history').append(`
                    <div class="mb-4 text-center">
                        <span class="badge bg-danger rounded-pill px-3 py-2">
                            <i class="bi bi-exclamation-triangle"></i> ${res.msg}
                        </span>
                    </div>
                `);
            }
            scrollToBottom();
        }).fail(function() {
             $(`#${loadingId}`).remove();
             $('#chat-history').append(`<div class="text-center mb-3"><span class="badge bg-secondary">ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°</span></div>`);
        });
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨è¾…åŠ©å‡½æ•°
    function scrollToBottom() {
        var chatHistory = document.getElementById("chat-history");
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
</script>
{% endblock %}