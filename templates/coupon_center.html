{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2 class="border-bottom pb-2 text-danger">ğŸ é¢†åˆ¸ä¸­å¿ƒ</h2>
    </div>

    {% for c in coupons %}
    <div class="col-md-4 mb-4">
        <div class="card border-danger shadow-sm h-100">
            <div class="card-body text-center d-flex flex-column justify-content-between">
                <div>
                    <h3 class="text-danger fw-bold display-5">Â¥ {{ c.amount }}</h3>
                    <p class="text-muted mb-2">æ»¡ {{ c.min_point }} å…ƒå¯ç”¨</p>
                    <h5 class="card-title text-truncate" title="{{ c.name }}">{{ c.name }}</h5>

                    {% set total = c.publish_count|default(0)|int %}
                    {% set received = c.receive_count|default(0)|int %}
                    {% if total > 0 %}
                        {% set percent = (received / total * 100) | round | int %}
                        {% if percent > 100 %}{% set percent = 100 %}{% endif %}
                    {% else %}
                        {% set percent = 0 %}
                    {% endif %}

                    <div class="progress mb-2 mt-3" style="height: 10px;">
                        <div class="progress-bar bg-danger" role="progressbar"
                             style="width: {{ percent }}%"
                             aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>

                    <p class="small text-secondary mb-3">
                        å·²æŠ¢ {{ received }} / {{ total }} å¼ <br>
                        æœ‰æ•ˆæœŸè‡³: {{ c.end_time }}
                    </p>
                </div>

                {% if received >= total %}
                    <button class="btn btn-secondary w-100" disabled>å·²æŠ¢å…‰</button>
                {% else %}
                    <button onclick="receiveCoupon('{{ c.id }}', this)" class="btn btn-outline-danger w-100">
                        ç«‹å³é¢†å–
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5 text-muted bg-light rounded">
        <h4>ğŸ˜” æš‚æ— æ­£åœ¨è¿›è¡Œçš„ä¼˜æƒ æ´»åŠ¨</h4>
        <p>è¿‡æ®µæ—¶é—´å†æ¥çœ‹çœ‹å§ï¼</p>
    </div>
    {% endfor %}
</div>

<script>
    // [ä¼˜åŒ–] æ¥æ”¶ btnElement å‚æ•°ï¼Œå…¼å®¹æ€§æ›´å¥½
    function receiveCoupon(id, btnElement) {
        var originalText = btnElement.innerHTML;

        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btnElement.disabled = true;
        btnElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> é¢†å–ä¸­...';

        $.post('/sms/receive_coupon', {coupon_id: id}, function(res){
            if(res.code === 200) {
                alert("ğŸ‰ " + res.msg);
                location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°è¿›åº¦
            } else if (res.code === 401) {
                if(confirm("é¢†å–ä¼˜æƒ åˆ¸éœ€è¦ç™»å½•ï¼Œç°åœ¨å»ç™»å½•å—ï¼Ÿ")) {
                    window.location.href = "/ums/login";
                } else {
                    // æ¢å¤æŒ‰é’®
                    btnElement.disabled = false;
                    btnElement.innerHTML = originalText;
                }
            } else {
                alert("âŒ " + res.msg);
                btnElement.disabled = false;
                btnElement.innerHTML = originalText;
            }
        }).fail(function() {
            alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            btnElement.disabled = false;
            btnElement.innerHTML = originalText;
        });
    }
</script>
{% endblock %}