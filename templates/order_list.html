{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4 border-bottom pb-2">ğŸ§¾ æˆ‘çš„è®¢å•åˆ—è¡¨</h2>

        {% for order in orders %}
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold me-3">è®¢å•å·: {{ order.order_sn }}</span>
                    <small class="text-muted">{{ order.create_time }}</small>
                </div>
                <div>
                    {% if order.status == 0 %}
                        <span class="badge bg-warning text-dark">å¾…ä»˜æ¬¾</span>
                    {% elif order.status == 1 %}
                        <span class="badge bg-info">å¾…å‘è´§</span>
                    {% elif order.status == 2 %}
                        <span class="badge bg-primary">å·²å‘è´§</span>
                    {% elif order.status == 3 %}
                        <span class="badge bg-success">å·²å®Œæˆ</span>
                    {% elif order.status == 4 %}
                        <span class="badge bg-secondary">å·²å…³é—­</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="mb-1"><strong>æ”¶è´§äºº:</strong> {{ order.receiver_name }} ({{ order.receiver_phone }})</p>
                        <p class="mb-1 text-muted"><strong>æ”¶è´§åœ°å€:</strong> {{ order.receiver_detail_address }}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <p class="mb-0 text-muted">è®¢å•æ€»é¢</p>
                        <h3 class="text-danger">Â¥ {{ order.total_amount }}</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white text-end">
                {% if order.status == 0 %}
                    <button onclick="cancelOrder('{{ order.id }}')" class="btn btn-sm btn-outline-secondary">å–æ¶ˆè®¢å•</button>
                    <button onclick="payOrder('{{ order.id }}')" class="btn btn-sm btn-danger">å»æ”¯ä»˜</button>
                {% elif order.status == 1 %}
                    <button class="btn btn-sm btn-light" disabled>å•†å®¶æ­£åœ¨æ‰“åŒ…...</button>
                {% elif order.status == 2 %}
                    <button onclick="confirmReceipt('{{ order.id }}')" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-check-circle"></i> ç¡®è®¤æ”¶è´§
                    </button>
                {% elif order.status == 3 %}
                    <a href="/pms/index" class="btn btn-sm btn-outline-success">å†æ¥ä¸€å•</a>
                {% else %}
                    <button class="btn btn-sm btn-light" disabled>å·²å…³é—­</button>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center py-5">
            <h4>æš‚æ— å†å²è®¢å•</h4>
            <p>æ‚¨è¿˜æ²¡æœ‰ä¹°è¿‡ä¸œè¥¿ï¼Œå¿«å»ä¸‹å•å§ï¼</p>
            <a href="/pms/index" class="btn btn-primary">å»è´­ç‰©</a>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // æ”¯ä»˜é€»è¾‘
    function payOrder(orderId) {
        if(confirm("æ¨¡æ‹Ÿæ”¯ä»˜ï¼šç¡®è®¤æ”¯ä»˜è¯¥è®¢å•å—ï¼Ÿ")) {
            $.post('/oms/pay_order', {order_id: orderId}, function(res){
                if(res.code === 200) {
                    alert("âœ… æ”¯ä»˜æˆåŠŸï¼");
                    location.reload();
                } else {
                    alert("æ”¯ä»˜å¤±è´¥: " + res.msg);
                }
            });
        }
    }

    // å–æ¶ˆé€»è¾‘
    function cancelOrder(orderId) {
        if(confirm("ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ")) {
            $.post('/oms/cancel_order', {order_id: orderId}, function(res){
                if(res.code === 200) {
                    alert("è®¢å•å·²å–æ¶ˆ");
                    location.reload();
                } else {
                    alert("å–æ¶ˆå¤±è´¥: " + res.msg);
                }
            });
        }
    }

    // [æ–°å¢] ç¡®è®¤æ”¶è´§é€»è¾‘
    function confirmReceipt(orderId) {
        if(confirm("ç¡®è®¤å·²æ”¶åˆ°å•†å“ä¸”æ— è¯¯å—ï¼Ÿ\nç¡®è®¤åè®¢å•å°†å®Œç»“ã€‚")) {
            $.post('/oms/confirm_receipt', {order_id: orderId}, function(res){
                if(res.code === 200) {
                    alert("ğŸ‰ äº¤æ˜“å®Œæˆï¼æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼");
                    location.reload();
                } else {
                    alert("æ“ä½œå¤±è´¥: " + res.msg);
                }
            });
        }
    }
</script>
{% endblock %}