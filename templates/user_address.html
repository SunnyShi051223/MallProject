{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h4 class="mb-4 text-primary"><i class="bi bi-geo-alt"></i> 地址管理</h4>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">添加新地址</div>
            <div class="card-body">
                <form id="add-addr-form">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-3">
                            <input type="text" name="name" class="form-control" placeholder="收货人姓名" required>
                        </div>
                        <div class="col-md-4">
                            <input type="text" name="phone" class="form-control" placeholder="手机号码" required>
                        </div>
                        <div class="col-md-5">
                            <div class="input-group">
                                <input type="text" name="detail" class="form-control" placeholder="详细地址 (如: 某小区3号楼)" required>
                                <button type="button" onclick="addAddress()" class="btn btn-primary">添加</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="list-group">
            {% for addr in addresses %}
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if addr.default_status %}border-primary bg-light{% endif %}">
                <div>
                    <h5 class="mb-1">
                        {{ addr.name }}
                        <small class="text-muted fs-6">{{ addr.phone_number }}</small>
                        {% if addr.default_status %}
                        <span class="badge bg-primary ms-2">默认地址</span>
                        {% endif %}
                    </h5>
                    <p class="mb-1 text-secondary">{{ addr.detail_address }}</p>
                </div>
                <div>
                    {% if not addr.default_status %}
                    <button onclick="setDefault({{ addr.id }})" class="btn btn-sm btn-outline-success">设为默认</button>
                    {% endif %}
                    <button onclick="delAddress({{ addr.id }})" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning text-center">暂无地址，请先添加一个吧！</div>
            {% endfor %}
        </div>

        <div class="mt-4">
            <a href="/oms/cart" class="btn btn-link text-decoration-none">
                <i class="bi bi-arrow-left"></i> 返回购物车
            </a>
        </div>
    </div>
</div>

<script>
    function addAddress() {
        var form = $('#add-addr-form');
        if(!form[0].checkValidity()) { form[0].reportValidity(); return; }

        $.post('/ums/address/add', form.serialize(), function(res){
            if(res.code === 200) {
                alert('地址添加成功，下次下单将默认使用此地址');
                location.reload();
            } else {
                alert(res.msg);
            }
        });
    }

    function setDefault(id) {
        $.post('/ums/address/set_default', {id: id}, function(res){
            if(res.code === 200) location.reload();
        });
    }

    function delAddress(id) {
        if(confirm('确定删除吗？')) {
            $.post('/ums/address/delete', {id: id}, function(res){
                if(res.code === 200) location.reload();
            });
        }
    }
</script>
{% endblock %}